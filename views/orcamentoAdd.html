{% extends 'body.html' %}

  {% block body %}

  <div class="style">

  <link rel="stylesheet" href="../site/css/orcamento.css">
  <style>
      .placa{
    top: 14rem;
    left: 14.5rem;
    width: 4.3rem;
  }

  .ano{
    top: 14rem;
    left: 20.5rem;
    width: 4rem;
  }
  .space{
   padding-top: 7px;
  }
  </style>
  </div>

  <div class="py-5 text-center">
    <h2 id="title">Novo orçamento</h2>

    <div class="row" id="avisoTempoTrabalho" hidden>
      <div class="col-6">
        <h4 id="aviso" class="my-3"></h4>
      </div>
      <div class="col-6">
        <h6 id="tempoTrabalho"class="my-3" ></h6>
      </div>
    </div>

    <div id="del" hidden>
      <a class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModel">Deletar orçamento</a>
    </div>
    
<!-- Modal -->
<div class="modal fade" id="deleteModel" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Atenção!</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Nenhuma alteração será salva, incluindo a <strong>cor do veículo</strong> cadastrada. Tem certeza que deseja deletar o orçamento?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a id="btnDel" class="btn btn-danger">Deletar</a>
      </div>
    </div>
  </div>
</div>

  </div>

      <form id="form" action="{{ url('orcamento/create') }}" method="get">

        <div class="row g-3 ">
            <div class="my-2 col-md-6 col-sm-12">
              <div id="image">
                <img src="../site/img/OrçamentoLimpo.png" alt="">

                <input type="text" name="nomeCliente" class="nomeCliente inputOrcamento">
                <input type="text" name="data" class="data inputOrcamento">
                <input type="text" name="endereco" class="endereco inputOrcamento">
                <input type="text" name="fone" value="(41) 9" class="fone inputOrcamento">
                <input type="text" name="car" class="car inputOrcamento">
                <input type="text" name="placa" class="placa inputOrcamento">
                <input type="text" name="ano" class="ano inputOrcamento">

                <input type="text" name="servico1" class="service1 inputOrcamentoPlane">
                <input type="text" name="valor1" class="valor1 inputOrcamentoPlane">

                <input type="text" name="servico2" class="service2 inputOrcamentoPlane">
                <input type="text" name="valor2" class="valor2 inputOrcamentoPlane">

                <input type="text" name="servico3" class="service3 inputOrcamentoPlane">
                <input type="text" name="valor3" class="valor3 inputOrcamentoPlane">

                <input type="text" name="servico4" class="service4 inputOrcamentoPlane">
                <input type="text" name="valor4" class="valor4 inputOrcamentoPlane">

                <input type="text" name="servico5" class="service5 inputOrcamentoPlane">
                <input type="text" name="valor5" class="valor5 inputOrcamentoPlane">

                <input type="text" name="servico6" class="service6 inputOrcamentoPlane">
                <input type="text" name="valor6" class="valor6 inputOrcamentoPlane">

                <input type="text" name="servico7" class="service7 inputOrcamentoPlane">
                <input type="text" name="valor7" class="valor7 inputOrcamentoPlane">

                <input type="text" name="servico8" class="service8 inputOrcamentoPlane">
                <input type="text" name="valor8" class="valor8 inputOrcamentoPlane">

                <input type="text" name="servico9" class="service9 inputOrcamentoPlane">
                <input type="text" name="valor9" class="valor9 inputOrcamentoPlane">

                <input type="text" name="obs" class="obs inputOrcamentoPlane">

                <input type="text" name="entrega" placeholder="   /   /   " class="entrega">

                <input type="text" name="totalPecas" class="totalPecas ">
                <input type="text" name="maoObre" class="maoObre">
                <input type="text" name="total" class="total">


              </div>
            </div>
            
            <div class="col-md-6 col-sm-12">
              <div onclick="view()" id="btnView" class="btn btn-outline-primary">
                Abrir <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-cash-coin space" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm5-4a5 5 0 1 1-10 0 5 5 0 0 1 10 0z"/>
                <path d="M9.438 11.944c.047.596.518 1.06 1.363 1.116v.44h.375v-.443c.875-.061 1.386-.529 1.386-1.207 0-.618-.39-.936-1.09-1.1l-.296-.07v-1.2c.376.043.614.248.671.532h.658c-.047-.575-.54-1.024-1.329-1.073V8.5h-.375v.45c-.747.073-1.255.522-1.255 1.158 0 .562.378.92 1.007 1.066l.248.061v1.272c-.384-.058-.639-.27-.696-.563h-.668zm1.36-1.354c-.369-.085-.569-.26-.569-.522 0-.294.216-.514.572-.578v1.1h-.003zm.432.746c.449.104.655.272.655.569 0 .339-.257.571-.709.614v-1.195l.054.012z"/>
                <path d="M1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.083c.058-.344.145-.678.258-1H3a2 2 0 0 0-2-2V3a2 2 0 0 0 2-2h10a2 2 0 0 0 2 2v3.528c.38.34.717.728 1 1.154V1a1 1 0 0 0-1-1H1z"/>
                <path d="M9.998 5.083 10 5a2 2 0 1 0-3.132 1.65 5.982 5.982 0 0 1 3.13-1.567z"/>
              </svg>
            </div><br><br>
              <div id="lucs" hidden>
                <h6>T. mão de obra: </h6>
                <div class="input-group mb-3">
                  <span class="input-group-text">R$</span>
                  <input type="text" id="tmaoobra" class="form-control" placeholder="">
                </div>
  
                <h6>T. custo de peça(produto) real: </h6>
                <div class="input-group mb-3">
                  <span class="input-group-text">R$</span>
                  <input type="text" id="valorpecaR" name="valorpecaR" class="form-control" placeholder="">
                </div>
  
                <h6>T. custo de peça(produto) para lucratividade: </h6>
                <div class="input-group mb-3">
                  <span class="input-group-text">R$</span>
                  <input type="text" id="valorpecaL" name="valorpecaL" class="form-control" placeholder="">
                </div>
                
                <h6>Custo de material: </h6>
                <div class="input-group mb-3">
                  <span class="input-group-text">R$</span>
                  <input type="text" id="valormaterial" name="valormaterial" class="form-control" placeholder="">
                </div>
                
                <h6>Custo de lavagem: </h6>
                <div class="input-group mb-3">
                  <span class="input-group-text">R$</span>
                  <input type="text" id="valorLavagem" name="valorLavagem" class="form-control" placeholder="">
                </div><br><br>
  
                <div id="valorDia">
                  <h6>Valor gasto por dia (Aluguel): </h6>
                  <div class="input-group mb-3">
                    <span class="input-group-text">R$</span>
                    <input type="text" id="valorDiaAluguel" name="valorDiaAluguel" class="form-control" placeholder="">
                  </div>
  
                  <h6>Custo por dia do aluguel: </h6>
                  <div class="input-group mb-3">
                    <span class="input-group-text">R$</span>
                    <input type="text" id="custoDia" value="60" class="form-control" placeholder="">
                  </div>
                </div><br><br>
                
                <div class="btn btn-outline-success my-3" onclick="sistemLucro()">Calcular lucro</div>
                <div class="input-group mb-3">
                  <span class="input-group-text bg-success" style="color: white;">R$</span>
                  <input type="text" id="lucro" name="lucro" class="form-control" placeholder="" style="border: 1px solid rgba(0, 128, 0, 0.593);">
                </div>
              </div>
            </div>
        </div>

        <select class="form-select form-select-lg mb-3 my-5" aria-label=".form-select-lg example" name="tipoServico" id="tipoServico">
          <option selected>Tipo do serviço a ser realizado</option>
          <option value="1">Reforma</option>
          <option value="2">Estética</option>
          <option value="3">Restauração</option>
          <option value="4">Ajustes</option>
          <option value="5">Procedimento Inteiro</option>
          <option value="6">Procedimento Razoável</option>

        </select>

        {% if dados != false %}

        {% for orcamento in orcamentos %}
        <script>
            $('#form').attr('action', '{{ url("update/orcamento/"~orcamento.id) }}')

          '{% if orcamento.states == 1 %}'

          document.getElementById('valorDia').hidden = false
          document.getElementById('avisoTempoTrabalho').hidden = false
          document.getElementById('aviso').innerHTML = 'Serviço já entregue!'
          document.getElementById('tempoTrabalho').innerHTML = 'Tempo na oficina: {{ diferencaTempo(orcamento.data_entrega, orcamento.dataR) }}'

          $('#custoDia').on('keyup', () => {
            var custoDia = Number('{{ diferencaTempoDia(orcamento.data_entrega, orcamento.dataR) }}')
            var valueDia = Number(document.getElementById('custoDia').value.replace('.', '').replace(',', '.'))
  
            document.getElementById('valorDiaAluguel').value = (custoDia * valueDia).toLocaleString('pt-br', {minimumFractionDigits: 2})
          })

          var custoDia = Number('{{ diferencaTempoDia(orcamento.data_entrega, orcamento.dataR) }}')
            var valueDia = Number(document.getElementById('custoDia').value.replace('.', '').replace(',', '.'))
  
            document.getElementById('valorDiaAluguel').value = (custoDia * valueDia).toLocaleString('pt-br', {minimumFractionDigits: 2})
          '{% endif %}'
          
          document.getElementById('title').innerHTML = 'Editar orçamento'
          document.getElementById('del').hidden = false
          document.getElementById('btnDel').href = "{{ url('orcamento/deletar/'~orcamento.id) }}"

          document.querySelector('.nomeCliente').value = '{{ orcamento.cliente }}'
          document.querySelector('.data').value = '{{ orcamento.dataR }}'
          document.querySelector('.endereco').value = '{{ orcamento.endereco }}'
          document.querySelector('.fone').value = '{{ orcamento.tel }}'
          document.querySelector('.car').value = '{{ orcamento.veiculo }}'
          document.querySelector('.placa').value = '{{ orcamento.placa }}'
          document.querySelector('.ano').value = '{{ orcamento.ano }}'
          document.querySelector('.obs').value = '{{ orcamento.obs }}'
          document.querySelector('.entrega').value = '{{ orcamento.previsao_entrega }}'
          document.querySelector('.totalPecas').value = '{{ orcamento.totalPecas }}'
          document.querySelector('.maoObre').value = '{{ orcamento.maoObra }}'
          document.querySelector('.total').value = '{{ orcamento.total }}'

        </script>
        {% endfor %}

        {% for lucro in lucros %}
        <script>
          document.getElementById('tmaoobra').value = ('{{ lucro.maoObra }}' == 0 ? '' : '{{ lucro.maoObra }}') 
          document.getElementById('valorpecaR').value = ('{{ lucro.valorPecaR }}' == 0 ? '' : '{{ lucro.valorPecaR }}') 
          document.getElementById('valorpecaL').value = ('{{ lucro.valorPecaL }}' == 0 ? '' : '{{ lucro.valorPecaL }}') 
          document.getElementById('valormaterial').value = ('{{ lucro.valorMaterial }}' == 0 ? '' : '{{ lucro.valorMaterial }}') 
          document.getElementById('valorLavagem').value = ('{{ lucro.valorLavagem }}' == 0 ? '' : '{{ lucro.valorLavagem }}') 
          document.getElementById('lucro').value = ('{{ lucro.lucro }}' == 0 ? '' : '{{ lucro.lucro }}') 

          $("#tipoServico").val('{{ lucro.tipo }}').change()

        </script>
        {% endfor %}

        {% for servico in servicos %}
          <script>
            document.querySelector('.service1').value = '{{ servico.servico1 }}'
            document.querySelector('.valor1').value = ('{{ servico.valor1 }}' == 0 ? '' : '{{ servico.valor1 }}')
            document.querySelector('.service2').value = '{{ servico.servico2 }}'
            document.querySelector('.valor2').value = ('{{ servico.valor2 }}' == 0 ? '' : '{{ servico.valor2 }}')
            document.querySelector('.service3').value = '{{ servico.servico3 }}'
            document.querySelector('.valor3').value = ('{{ servico.valor3 }}' == 0 ? '' : '{{ servico.valor3 }}')

            document.querySelector('.service4').value = '{{ servico.servico4 }}'
            document.querySelector('.valor4').value = ('{{ servico.valor4 }}' == 0 ? '' : '{{ servico.valor4 }}')

            document.querySelector('.service5').value = '{{ servico.servico5 }}'
            document.querySelector('.valor5').value = ('{{ servico.valor5 }}' == 0 ? '' : '{{ servico.valor5 }}')
            document.querySelector('.service6').value = '{{ servico.servico6 }}'
            document.querySelector('.valor6').value = ('{{ servico.valor6 }}' == 0 ? '' : '{{ servico.6 }}')
            document.querySelector('.service7').value = '{{ servico.servico7 }}'
            document.querySelector('.valor7').value = ('{{ servico.valor7 }}' == 0 ? '' : '{{ servico.valor7 }}')
            document.querySelector('.service8').value = '{{ servico.servico8 }}'
            document.querySelector('.valor8').value = ('{{ servico.valor8 }}' == 0 ? '' : '{{ servico.valor8 }}')
            document.querySelector('.service9').value = '{{ servico.servico9 }}'
            document.querySelector('.valor9').value = ('{{ servico.valor9 }}' == 0 ? '' : '{{ servico.valor9 }}')

          </script>
        {% endfor %}
        
        {% endif %}


        <hr class="my-4">

        <div class="w-100 btn btn-outline-success btn-lg" onclick="image()"  data-bs-toggle="modal" data-bs-target="#exampleModal"><svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" fill="currentColor" class="bi bi-filetype-png" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2v-1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5Zm-3.76 8.132c.076.153.123.317.14.492h-.776a.797.797 0 0 0-.097-.249.689.689 0 0 0-.17-.19.707.707 0 0 0-.237-.126.96.96 0 0 0-.299-.044c-.285 0-.506.1-.665.302-.156.201-.234.484-.234.85v.498c0 .234.032.439.097.615a.881.881 0 0 0 .304.413.87.87 0 0 0 .519.146.967.967 0 0 0 .457-.096.67.67 0 0 0 .272-.264c.06-.11.091-.23.091-.363v-.255H8.82v-.59h1.576v.798c0 .193-.032.377-.097.55a1.29 1.29 0 0 1-.293.458 1.37 1.37 0 0 1-.495.313c-.197.074-.43.111-.697.111a1.98 1.98 0 0 1-.753-.132 1.447 1.447 0 0 1-.533-.377 1.58 1.58 0 0 1-.32-.58 2.482 2.482 0 0 1-.105-.745v-.506c0-.362.067-.678.2-.95.134-.271.328-.482.582-.633.256-.152.565-.228.926-.228.238 0 .45.033.636.1.187.066.348.158.48.275.133.117.238.253.314.407Zm-8.64-.706H0v4h.791v-1.343h.803c.287 0 .531-.057.732-.172.203-.118.358-.276.463-.475a1.42 1.42 0 0 0 .161-.677c0-.25-.053-.475-.158-.677a1.176 1.176 0 0 0-.46-.477c-.2-.12-.443-.179-.732-.179Zm.545 1.333a.795.795 0 0 1-.085.381.574.574 0 0 1-.238.24.794.794 0 0 1-.375.082H.788v-1.406h.66c.218 0 .389.06.512.182.123.12.185.295.185.521Zm1.964 2.666V13.25h.032l1.761 2.675h.656v-3.999h-.75v2.66h-.032l-1.752-2.66h-.662v4h.747Z"/>
        </svg> Gerar imagem</div>
<br><br>
        <button class="w-100 btn btn-primary btn-lg" type="submit">Criar orçamento</button>
      </form>
<br><br>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Imagem realizada!</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="localImg">
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <a id="btnImage" href="" download="" class="btn btn-primary">Download</a>
      </div>
    </div>
  </div>
</div>




<script>
  if(document.querySelector('.data').value == ''){
    const date = new Date();
    document.querySelector('.data').value = date.toLocaleDateString();
  }

  let tmaoObra = document.querySelector('#tmaoobra')
  let valorPecaL = document.querySelector('#valorpecaL')
  let valorPecaR = document.querySelector('#valorpecaR')
  let lucro = document.querySelector('#lucro')
  let valormaterial = document.querySelector('#valormaterial')
  let valorLavagem = document.querySelector('#valorLavagem')

  function sistemLucro(){
    let vpl = Number(valorPecaL.value.replace(".", "").replace(",", "."))
    let vpr = Number(valorPecaR.value.replace(".", "").replace(",", "."))
    let vmo = Number(tmaoObra.value.replace(".", "").replace(",", "."))
    let vm =  Number(valormaterial.value.replace(".", "").replace(",", "."))
    let vl =  Number(valorLavagem.value.replace(".", "").replace(",", "."))
    lucro.value = (vpl - vpr + vmo - vm - vl).toLocaleString('pt-br', {minimumFractionDigits: 2})
  }

  let maoObre = document.querySelector('.maoObre')
  maoObre.addEventListener('keyup', () => {

    document.querySelector('.total').value = (Number(maoObre.value.replace(".", "").replace(",", ".")) + Number(totalPecas.value.replace(".", "").replace(",", "."))).toLocaleString('pt-br', {minimumFractionDigits: 2})
    
    tmaoObra.value = maoObre.value
  })
  let totalPecas = document.querySelector('.totalPecas')
  totalPecas.addEventListener('keyup', () => {

    document.querySelector('.total').value = (Number(maoObre.value.replace(".", "").replace(",", ".")) + Number(totalPecas.value.replace(".", "").replace(",", "."))).toLocaleString('pt-br', {minimumFractionDigits: 2})

    valorPecaL.value = totalPecas.value
  })


  function image(){

    

    $(document).ready(function() {
          
          // Global variable
          var element = $("#image"); 
        
          // Global variable
          var image; 

              html2canvas(document.querySelector("#image")).then(canvas => {
                console.log(canvas)
                $('#localImg').append(canvas)

              var imgageData = canvas.toDataURL("image/png");
            
              var newData = imgageData.replace(
              /^data:image\/png/, "data:application/octet-stream");

              let nomeCliente = document.querySelector('.nomeCliente')

              document.getElementById('btnImage').hidden = false
              $("#btnImage").attr(
                "download", "orçamento - ("+ nomeCliente.value +").png").attr(
                "href", newData);
              });

     });

              
  }

  function view(){
    let lucs = document.getElementById('lucs')
    let btnView = document.getElementById('btnView')
    if(lucs.hidden){
      lucs.hidden = false
      // btnView.style.top = '12.5rem'
      btnView.innerHTML = "Fechar <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-x-lg viewBox='0 0 16 16'>"+
  "<path d='M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z'/>"+
"</svg>"
    }else{
      lucs.hidden = true
      // btnView.style.top = ''
      btnView.innerHTML = "Abrir <svg xmlns='http://www.w3.org/2000/svg' width='16' height='20' fill='currentColor' class='bi bi-cash-coin space' viewBox='0 0 16 16'>"+
                "<path fill-rule='evenodd' d='M11 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm5-4a5 5 0 1 1-10 0 5 5 0 0 1 10 0z'/>"+
                "<path d='M9.438 11.944c.047.596.518 1.06 1.363 1.116v.44h.375v-.443c.875-.061 1.386-.529 1.386-1.207 0-.618-.39-.936-1.09-1.1l-.296-.07v-1.2c.376.043.614.248.671.532h.658c-.047-.575-.54-1.024-1.329-1.073V8.5h-.375v.45c-.747.073-1.255.522-1.255 1.158 0 .562.378.92 1.007 1.066l.248.061v1.272c-.384-.058-.639-.27-.696-.563h-.668zm1.36-1.354c-.369-.085-.569-.26-.569-.522 0-.294.216-.514.572-.578v1.1h-.003zm.432.746c.449.104.655.272.655.569 0 .339-.257.571-.709.614v-1.195l.054.012z'/>"+
                "<path d='M1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.083c.058-.344.145-.678.258-1H3a2 2 0 0 0-2-2V3a2 2 0 0 0 2-2h10a2 2 0 0 0 2 2v3.528c.38.34.717.728 1 1.154V1a1 1 0 0 0-1-1H1z'/>"+
                "<path d='M9.998 5.083 10 5a2 2 0 1 0-3.132 1.65 5.982 5.982 0 0 1 3.13-1.567z'/>"+
              "</svg>"
    }
  }
</script>


  {% endblock %}
